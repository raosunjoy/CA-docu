// Zetra Platform - Database Schema
// Unified Productivity Platform for Indian CA Firms

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Role Enum
enum UserRole {
  PARTNER
  MANAGER
  ASSOCIATE
  INTERN
  ADMIN
}

// Task Status Enum
enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  COMPLETED
  CANCELLED
}

// Task Priority Enum
enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Approval Status Enum
enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  DELEGATED
  CANCELLED
}

// Approval Decision Enum
enum ApprovalDecision {
  APPROVE
  REJECT
  DELEGATE
  REQUEST_CHANGES
}

// Time Entry Status Enum
enum TimeEntryStatus {
  RUNNING
  STOPPED
  SUBMITTED
  APPROVED
  REJECTED
}

// Time Entry Type Enum
enum TimeEntryType {
  WORK
  BREAK
  MEETING
  TRAVEL
  ADMIN
}

// Channel Type Enum
enum ChannelType {
  DIRECT
  GROUP
  TASK
  CLIENT
}

// Message Type Enum
enum MessageType {
  TEXT
  FILE
  TASK_REFERENCE
  EMAIL_REFERENCE
}

// Core Organization Model
model Organization {
  id        String   @id @default(cuid())
  name      String
  subdomain String   @unique
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users      User[]
  tags       Tag[]
  tasks      Task[]
  documents  Document[]
  documentFolders DocumentFolder[]
  emailAccounts EmailAccount[]
  emails     Email[]
  emailTemplates EmailTemplate[]
  chatChannels ChatChannel[]
  auditLogs     AuditLog[]
  auditPolicies AuditPolicy[]
  auditReports  AuditReport[]
  
  // Approval workflow relations
  approvalWorkflows ApprovalWorkflow[]
  approvalRequests  ApprovalRequest[]
  approvalTemplates ApprovalTemplate[]
  approvalDelegates ApprovalDelegate[]
  
  // Time tracking relations
  timeEntries       TimeEntry[]
  timeBudgets       TimeBudget[]
  timeReports       TimeReport[]
  productivityMetrics ProductivityMetric[]
  
  // Recurring task and automation relations
  recurringTasks    RecurringTask[]
  automationRules   AutomationRule[]
  workloadMetrics   WorkloadMetric[]
  escalationRules   EscalationRule[]
  taskSuggestions   TaskSuggestion[]
  
  // Client portal relations
  clients           Client[]
  clientEngagements ClientEngagement[]
  clientDocumentRequests ClientDocumentRequest[]
  clientDocuments   ClientDocument[]
  clientMessages    ClientMessage[]
  clientNotifications ClientNotification[]
  clientFeedbacks   ClientFeedback[]
  clientMeetings    ClientMeeting[]
  clientInvoices    ClientInvoice[]
  clientProgressUpdates ClientProgressUpdate[]

  @@map("organizations")
}

// User Management
model User {
  id             String    @id @default(cuid())
  organizationId String
  email          String    @unique
  passwordHash   String?
  firstName      String
  lastName       String
  role           UserRole
  isActive       Boolean   @default(true)
  lastLoginAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Created content
  createdTasks      Task[]         @relation("TaskCreator")
  assignedTasks     Task[]         @relation("TaskAssignee")
  lockedTasks       Task[]         @relation("TaskLocker")
  uploadedDocuments Document[]     @relation("DocumentUploader")
  createdTags       Tag[]          @relation("TagCreator")
  emailAccounts     EmailAccount[] @relation("EmailAccounts")
  sentMessages      ChatMessage[]  @relation("MessageSender")
  createdChannels   ChatChannel[]  @relation("ChannelCreator")
  uploadedChatFiles ChatFile[]     @relation("ChatFileUploader")
  taggedBy          Tagging[]      @relation("TaggerUser")
  auditLogs         AuditLog[]     @relation("AuditUser")
  syncStatus        SyncStatus[]
  taskComments      TaskComment[]
  taskAttachments   TaskAttachment[]
  channelMemberships ChatChannelMember[]
  
  // Document Management relations
  createdFolders    DocumentFolder[]    @relation("FolderCreator")
  documentAnnotations DocumentAnnotation[] @relation("DocumentAnnotator")
  sharedDocuments   DocumentShare[]     @relation("DocumentSharer")
  receivedShares    DocumentShare[]     @relation("DocumentRecipient")
  documentComments  DocumentComment[]   @relation("DocumentCommenter")
  folderPermissions FolderPermission[]  @relation("FolderPermissionUser")
  
  // Approval workflow relations
  createdWorkflows  ApprovalWorkflow[]  @relation("WorkflowCreator")
  approvalRequests  ApprovalRequest[]   @relation("ApprovalRequests")
  delegatedApprovals ApprovalRequest[]  @relation("DelegatedApprovals")
  createdTemplates  ApprovalTemplate[]  @relation("TemplateCreator")
  delegatorRelations ApprovalDelegate[] @relation("ApprovalDelegator")
  delegateRelations ApprovalDelegate[]  @relation("ApprovalDelegate")
  
  // Time tracking relations
  timeEntries       TimeEntry[]         @relation("TimeEntryUser")
  approvedTimeEntries TimeEntry[]       @relation("TimeEntryApprover")
  timeBudgets       TimeBudget[]        @relation("TimeBudgetUser")
  createdTimeBudgets TimeBudget[]       @relation("TimeBudgetCreator")
  generatedReports  TimeReport[]        @relation("TimeReportGenerator")
  productivityMetrics ProductivityMetric[] @relation("ProductivityMetrics")
  
  // Recurring task and automation relations
  assignedRecurringTasks RecurringTask[] @relation("RecurringTaskAssignee")
  createdRecurringTasks  RecurringTask[] @relation("RecurringTaskCreator")
  createdAutomationRules AutomationRule[] @relation("AutomationRuleCreator")
  workloadMetrics        WorkloadMetric[] @relation("WorkloadMetrics")
  createdEscalationRules EscalationRule[] @relation("EscalationRuleCreator")
  taskSuggestions        TaskSuggestion[] @relation("TaskSuggestions")
  createdEmailTemplates  EmailTemplate[]  @relation("EmailTemplateCreator")
  
  // Notification relations
  notifications          Notification[]   @relation("UserNotifications")
  notificationPreferences NotificationPreferences? @relation("UserNotificationPreferences")
  pushSubscriptions      PushSubscription[] @relation("UserPushSubscriptions")
  
  // Cross-device sync relations
  syncDevices            SyncDevice[]     @relation("UserSyncDevices")
  syncData               SyncData[]       @relation("UserSyncData")
  syncConflicts          SyncConflict[]   @relation("UserSyncConflicts")

  @@index([organizationId])
  @@index([email])
  @@index([role])
  @@map("users")
}

// Hierarchical Tag System
model Tag {
  id             String    @id @default(cuid())
  organizationId String
  name           String
  parentId       String?
  color          String?   // Hex color code
  description    String?
  createdBy      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator      User?        @relation("TagCreator", fields: [createdBy], references: [id])
  parent       Tag?         @relation("TagHierarchy", fields: [parentId], references: [id])
  children     Tag[]        @relation("TagHierarchy")
  taggings     Tagging[]

  @@unique([organizationId, name, parentId])
  @@index([organizationId])
  @@index([parentId])
  @@map("tags")
}

// Task Management
model Task {
  id             String        @id @default(cuid())
  organizationId String
  title          String
  description    String?
  status         TaskStatus    @default(TODO)
  priority       TaskPriority  @default(MEDIUM)
  assignedTo     String?
  createdBy      String
  parentTaskId   String?
  dueDate        DateTime?
  completedAt    DateTime?
  lockedAt       DateTime?
  lockedBy       String?
  estimatedHours Int?
  actualHours    Int?
  
  // Approval workflow fields
  requiresApproval Boolean       @default(false)
  approvalStatus   ApprovalStatus?
  currentApprovalStep Int?       @default(0)
  
  // Recurring task fields
  isRecurring      Boolean       @default(false)
  recurringTaskId  String?       // Reference to RecurringTask
  instanceNumber   Int?          // For recurring task instances
  
  // Automation fields
  isAutoAssigned   Boolean       @default(false)
  autoAssignmentReason String?   // Reason for auto-assignment
  escalationLevel  Int           @default(0)
  lastEscalatedAt  DateTime?
  
  metadata       Json          @default("{}")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedUser   User?        @relation("TaskAssignee", fields: [assignedTo], references: [id])
  createdByUser  User         @relation("TaskCreator", fields: [createdBy], references: [id])
  lockedByUser   User?        @relation("TaskLocker", fields: [lockedBy], references: [id])
  parentTask     Task?        @relation("TaskHierarchy", fields: [parentTaskId], references: [id])
  childTasks     Task[]       @relation("TaskHierarchy")
  comments       TaskComment[]
  attachments    TaskAttachment[]
  
  // Approval workflow relations
  approvalWorkflow ApprovalWorkflow?
  approvalRequests ApprovalRequest[]
  
  // Time tracking relations
  timeEntries      TimeEntry[]
  timeBudgets      TimeBudget[]
  
  // Recurring task relations
  recurringTask    RecurringTask? @relation(fields: [recurringTaskId], references: [id])
  
  // Automation relations
  automationTriggers AutomationTrigger[]
  escalationLogs     EscalationLog[]
  
  // Client portal relations
  clientEngagementTasks ClientEngagementTask[]

  @@index([organizationId])
  @@index([assignedTo])
  @@index([status])
  @@index([dueDate])
  @@index([createdBy])
  @@index([parentTaskId])
  @@index([recurringTaskId])
  @@index([isRecurring])
  @@index([escalationLevel])
  @@map("tasks")
}

// Task Comments
model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@map("task_comments")
}

// Task Attachments
model TaskAttachment {
  id         String  @id @default(cuid())
  taskId     String
  documentId String?
  fileName   String
  filePath   String
  fileSize   Int
  mimeType   String
  uploadedBy String
  createdAt  DateTime @default(now())

  // Relations
  task     Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [uploadedBy], references: [id])
  document Document? @relation(fields: [documentId], references: [id])

  @@index([taskId])
  @@index([documentId])
  @@map("task_attachments")
}

// Document Management
model Document {
  id               String         @id @default(cuid())
  organizationId   String
  name             String
  originalName     String?        // Original filename
  description      String?
  filePath         String         // Current file path
  localPath        String?        // Local sync path
  cloudPath        String?        // Cloud storage path
  thumbnailPath    String?        // Preview/thumbnail path
  fileSize         Int
  mimeType         String
  checksum         String?        // For integrity and deduplication
  type             DocumentType   @default(OTHER)
  status           DocumentStatus @default(ACTIVE)
  version          Int            @default(1)
  parentDocumentId String?
  folderId         String?        // Reference to DocumentFolder
  uploadedBy       String
  uploadedAt       DateTime       @default(now())
  lastAccessedAt   DateTime?
  extractedText    String?        // OCR/searchable text
  metadata         Json           @default("{}")
  isDeleted        Boolean        @default(false)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  organization     Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploader         User                @relation("DocumentUploader", fields: [uploadedBy], references: [id])
  folder           DocumentFolder?     @relation(fields: [folderId], references: [id])
  parentDocument   Document?           @relation("DocumentVersions", fields: [parentDocumentId], references: [id])
  childDocuments   Document[]          @relation("DocumentVersions")
  
  // Enhanced relations for document management
  annotations      DocumentAnnotation[]
  shares           DocumentShare[]
  comments         DocumentComment[]
  taskAttachments  TaskAttachment[]
  // Note: Taggings are handled via polymorphic relations in application code

  @@index([organizationId])
  @@index([uploadedBy])
  @@index([folderId])
  @@index([status])
  @@index([type])
  @@index([checksum])
  @@index([createdAt])
  @@map("documents")
}

// Email Integration System

// Email Provider Enum
enum EmailProvider {
  GMAIL
  OUTLOOK
  EXCHANGE
  IMAP
}

// Email Account Status Enum
enum EmailAccountStatus {
  ACTIVE
  INACTIVE
  ERROR
  EXPIRED
  REVOKED
}

// Email Sync Status Enum
enum EmailSyncStatus {
  IDLE
  SYNCING
  ERROR
  PAUSED
}

// Email Account Model
model EmailAccount {
  id             String             @id @default(cuid())
  organizationId String
  userId         String
  provider       EmailProvider
  email          String
  displayName    String?
  
  // OAuth2 credentials
  accessToken    String?            // Encrypted
  refreshToken   String?            // Encrypted
  tokenExpiresAt DateTime?
  
  // IMAP/SMTP credentials (encrypted)
  imapHost       String?
  imapPort       Int?
  smtpHost       String?
  smtpPort       Int?
  username       String?
  password       String?            // Encrypted
  
  // Account settings
  isDefault      Boolean            @default(false)
  status         EmailAccountStatus @default(ACTIVE)
  syncStatus     EmailSyncStatus    @default(IDLE)
  lastSyncAt     DateTime?
  syncError      String?
  
  // Sync configuration
  syncEnabled    Boolean            @default(true)
  syncFolders    String[]           @default(["INBOX"])
  maxSyncDays    Int                @default(30)
  
  // Metadata
  metadata       Json               @default("{}")
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  // Relations
  organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User               @relation("EmailAccounts", fields: [userId], references: [id])
  emails         Email[]
  emailFolders   EmailFolder[]
  emailTemplates EmailTemplate[]

  @@unique([userId, email])
  @@index([organizationId])
  @@index([userId])
  @@index([provider])
  @@index([status])
  @@map("email_accounts")
}

// Email Folder Model
model EmailFolder {
  id             String       @id @default(cuid())
  accountId      String
  name           String
  displayName    String?
  externalId     String?      // Provider-specific folder ID
  parentId       String?
  path           String       // Full folder path
  type           String       @default("custom") // inbox, sent, drafts, trash, spam, custom
  unreadCount    Int          @default(0)
  totalCount     Int          @default(0)
  isSelectable   Boolean      @default(true)
  metadata       Json         @default("{}")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  account        EmailAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  parent         EmailFolder? @relation("FolderHierarchy", fields: [parentId], references: [id])
  children       EmailFolder[] @relation("FolderHierarchy")
  emails         Email[]

  @@unique([accountId, externalId])
  @@index([accountId])
  @@index([parentId])
  @@index([type])
  @@map("email_folders")
}

// Enhanced Email Model
model Email {
  id             String        @id @default(cuid())
  organizationId String
  accountId      String
  folderId       String?
  
  // Email identifiers
  externalId     String        // Provider-specific message ID
  threadId       String?       // Conversation thread ID
  messageId      String?       // RFC 2822 Message-ID
  inReplyTo      String?       // In-Reply-To header
  references     String[]      // References header
  
  // Email content
  subject        String?
  fromAddress    String
  fromName       String?
  toAddresses    String[]
  toNames        String[]
  ccAddresses    String[]
  ccNames        String[]
  bccAddresses   String[]
  bccNames       String[]
  replyToAddress String?
  bodyText       String?
  bodyHtml       String?
  snippet        String?       // Email preview text
  
  // Email metadata
  importance     String        @default("normal") // low, normal, high
  priority       String        @default("normal") // low, normal, high
  sensitivity    String        @default("normal") // normal, personal, private, confidential
  size           Int?          // Email size in bytes
  
  // Flags and status
  isRead         Boolean       @default(false)
  isStarred      Boolean       @default(false)
  isFlagged      Boolean       @default(false)
  isArchived     Boolean       @default(false)
  isDeleted      Boolean       @default(false)
  isDraft        Boolean       @default(false)
  isSent         Boolean       @default(false)
  
  // Labels and categories
  labels         String[]      @default([])
  categories     String[]      @default([])
  
  // Integration
  linkedTaskIds  String[]      @default([])
  linkedDocIds   String[]      @default([])
  
  // Timestamps
  sentAt         DateTime?
  receivedAt     DateTime
  syncedAt       DateTime      @default(now())
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  account        EmailAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  folder         EmailFolder?  @relation(fields: [folderId], references: [id])
  attachments    EmailAttachment[]
  
  @@unique([accountId, externalId])
  @@index([organizationId])
  @@index([accountId])
  @@index([folderId])
  @@index([threadId])
  @@index([receivedAt])
  @@index([isRead])
  @@index([isDeleted])
  @@index([linkedTaskIds])
  @@map("emails")
}

// Email Attachment Model
model EmailAttachment {
  id             String   @id @default(cuid())
  emailId        String
  filename       String
  contentType    String
  size           Int
  contentId      String?  // For inline attachments
  isInline       Boolean  @default(false)
  downloadUrl    String?  // Temporary download URL
  filePath       String?  // Local file path if downloaded
  checksum       String?  // File integrity check
  createdAt      DateTime @default(now())

  // Relations
  email          Email    @relation(fields: [emailId], references: [id], onDelete: Cascade)

  @@index([emailId])
  @@index([contentId])
  @@map("email_attachments")
}

// Email Template Model
model EmailTemplate {
  id             String       @id @default(cuid())
  organizationId String
  accountId      String?      // Optional: template specific to account
  name           String
  description    String?
  category       String?      // e.g., 'client_communication', 'internal', 'compliance'
  
  // Template content
  subject        String
  bodyHtml       String
  bodyText       String?
  
  // Template variables
  variables      Json         @default("[]") // Array of variable definitions
  
  // Settings
  isShared       Boolean      @default(false)
  isActive       Boolean      @default(true)
  usageCount     Int          @default(0)
  
  // Metadata
  createdBy      String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  account        EmailAccount? @relation(fields: [accountId], references: [id])
  creator        User         @relation("EmailTemplateCreator", fields: [createdBy], references: [id])

  @@index([organizationId])
  @@index([accountId])
  @@index([category])
  @@index([isActive])
  @@map("email_templates")
}

// Email Sync Log Model
model EmailSyncLog {
  id             String          @id @default(cuid())
  accountId      String
  syncType       String          // 'full', 'incremental', 'folder'
  status         String          // 'started', 'completed', 'failed'
  startedAt      DateTime        @default(now())
  completedAt    DateTime?
  
  // Sync statistics
  emailsProcessed Int            @default(0)
  emailsAdded    Int             @default(0)
  emailsUpdated  Int             @default(0)
  emailsDeleted  Int             @default(0)
  errorsCount    Int             @default(0)
  
  // Error details
  error          String?
  errorDetails   Json?
  
  // Sync metadata
  metadata       Json            @default("{}")

  @@index([accountId])
  @@index([status])
  @@index([startedAt])
  @@map("email_sync_logs")
}

// Chat System
model ChatChannel {
  id             String      @id @default(cuid())
  organizationId String
  name           String
  type           ChannelType
  metadata       Json        @default("{}")
  createdBy      String
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator      User         @relation("ChannelCreator", fields: [createdBy], references: [id])
  messages     ChatMessage[]
  members      ChatChannelMember[]
  files        ChatFile[]

  @@index([organizationId])
  @@map("chat_channels")
}

model ChatChannelMember {
  id        String   @id @default(cuid())
  channelId String
  userId    String
  joinedAt  DateTime @default(now())

  // Relations
  channel ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user    User        @relation(fields: [userId], references: [id])

  @@unique([channelId, userId])
  @@map("chat_channel_members")
}

model ChatMessage {
  id          String      @id @default(cuid())
  channelId   String
  userId      String
  content     String
  messageType MessageType @default(TEXT)
  metadata    Json        @default("{}")
  repliedToId String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  channel   ChatChannel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user      User         @relation("MessageSender", fields: [userId], references: [id])
  repliedTo ChatMessage? @relation("MessageReplies", fields: [repliedToId], references: [id])
  replies   ChatMessage[] @relation("MessageReplies")

  @@index([channelId])
  @@index([userId])
  @@index([createdAt])
  @@map("chat_messages")
}

// Chat File Model
model ChatFile {
  id           String   @id @default(cuid())
  channelId    String
  uploadedBy   String
  originalName String
  fileName     String
  filePath     String
  fileSize     Int
  mimeType     String
  caption      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  channel   ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  uploader  User        @relation("ChatFileUploader", fields: [uploadedBy], references: [id])

  @@index([channelId])
  @@index([uploadedBy])
  @@index([createdAt])
  @@map("chat_files")
}

// Polymorphic Tagging System
model Tagging {
  id           String @id @default(cuid())
  tagId        String
  taggableType String // 'task', 'document', 'email', 'chat_channel'
  taggableId   String
  taggedBy     String?
  createdAt    DateTime @default(now())

  // Relations
  tag    Tag   @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagger User? @relation("TaggerUser", fields: [taggedBy], references: [id])

  // Note: Polymorphic relations are handled in application code
  // taggableType and taggableId reference different models based on type

  @@unique([tagId, taggableType, taggableId])
  @@index([tagId])
  @@index([taggableType, taggableId])
  @@map("taggings")
}

// Notification System
model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // 'chat_mention', 'direct_message', 'task_update', etc.
  title     String
  message   String
  data      Json     @default("{}")
  read      Boolean  @default(false)
  readAt    DateTime?
  expiresAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationPreferences {
  id          String   @id @default(cuid())
  userId      String   @unique
  preferences Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User @relation("UserNotificationPreferences", fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model PushSubscription {
  id       String @id @default(cuid())
  userId   String
  endpoint String
  p256dh   String // Public key for encryption
  auth     String // Authentication secret
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation("UserPushSubscriptions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
  @@map("push_subscriptions")
}

// Enhanced Audit Trail System
enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  SHARE
  DOWNLOAD
  UPLOAD
  APPROVE
  REJECT
  ASSIGN
  UNASSIGN
  ARCHIVE
  RESTORE
  SYNC
  BACKUP
  RESTORE_BACKUP
}

enum AuditSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AuditCategory {
  AUTHENTICATION
  AUTHORIZATION
  DATA_ACCESS
  DATA_MODIFICATION
  SYSTEM_ADMIN
  COMPLIANCE
  SECURITY
  INTEGRATION
  BACKUP_RECOVERY
}

model AuditLog {
  id             String        @id @default(cuid())
  organizationId String
  userId         String?
  sessionId      String?       // Session identifier
  
  // Action details
  action         AuditAction
  category       AuditCategory
  severity       AuditSeverity @default(LOW)
  description    String
  
  // Resource information
  resourceType   String        // 'task', 'document', 'user', etc.
  resourceId     String?
  resourceName   String?       // Human-readable resource name
  
  // Change tracking
  oldValues      Json?         // Previous state (encrypted if sensitive)
  newValues      Json?         // New state (encrypted if sensitive)
  changesSummary String?       // Human-readable summary of changes
  
  // Context information
  ipAddress      String?
  userAgent      String?
  deviceId       String?
  location       String?       // Geo-location if available
  
  // Request context
  requestId      String?       // Correlation ID for request tracing
  endpoint       String?       // API endpoint or page accessed
  method         String?       // HTTP method
  
  // Compliance and security
  complianceFlags String[]     @default([]) // Regulatory compliance markers
  riskScore      Int?          // Risk assessment score (0-100)
  
  // Metadata
  metadata       Json          @default("{}")
  tags           String[]      @default([])
  
  // Immutability and integrity
  checksum       String?       // Hash for integrity verification
  previousLogId  String?       // Chain to previous log for integrity
  
  // Timestamps
  occurredAt     DateTime      // When the actual event occurred
  createdAt      DateTime      @default(now())

  // Relations
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?         @relation("AuditUser", fields: [userId], references: [id])
  
  // Self-referential for log chaining
  previousLog    AuditLog?     @relation("AuditChain", fields: [previousLogId], references: [id])
  nextLogs       AuditLog[]    @relation("AuditChain")

  @@index([organizationId])
  @@index([userId])
  @@index([sessionId])
  @@index([action])
  @@index([category])
  @@index([severity])
  @@index([resourceType, resourceId])
  @@index([occurredAt])
  @@index([createdAt])
  @@index([complianceFlags])
  @@index([riskScore])
  @@index([checksum])
  @@map("audit_logs")
}

// Audit Log Search Index for complex queries
model AuditLogIndex {
  id             String   @id @default(cuid())
  auditLogId     String   @unique
  searchableText String   // Concatenated searchable fields
  keywords       String[] // Extracted keywords for search
  createdAt      DateTime @default(now())

  @@index([searchableText])
  @@index([keywords])
  @@map("audit_log_index")
}

// Audit Configuration and Policies
model AuditPolicy {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  
  // Policy configuration
  resourceTypes  String[] // Which resource types to audit
  actions        String[] // Which actions to audit
  categories     String[] // Which categories to audit
  
  // Retention and archival
  retentionDays  Int      @default(2555) // ~7 years default
  archiveAfterDays Int?   // Archive to cold storage after X days
  
  // Compliance settings
  complianceRequired Boolean @default(false)
  encryptSensitiveData Boolean @default(true)
  requireIntegrityCheck Boolean @default(true)
  
  // Alert settings
  alertOnHighRisk Boolean @default(true)
  alertThreshold  Int     @default(75) // Risk score threshold
  
  // Status
  isActive       Boolean  @default(true)
  
  // Metadata
  createdBy      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([isActive])
  @@map("audit_policies")
}

// Audit Reports for compliance and analysis
model AuditReport {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  
  // Report configuration
  reportType     String   // 'compliance', 'security', 'activity', 'custom'
  filters        Json     // Search and filter criteria
  dateRange      Json     // Start and end dates
  
  // Report data
  totalRecords   Int      @default(0)
  reportData     Json?    // Generated report data (may be large)
  summary        Json?    // Executive summary
  
  // File information
  filePath       String?  // Path to generated report file
  fileFormat     String?  // 'pdf', 'excel', 'csv', 'json'
  fileSize       Int?
  
  // Status and scheduling
  status         String   @default("pending") // 'pending', 'generating', 'completed', 'failed'
  isScheduled    Boolean  @default(false)
  schedule       Json?    // Cron-like schedule configuration
  lastGenerated  DateTime?
  nextGeneration DateTime?
  
  // Access control
  isPublic       Boolean  @default(false)
  allowedRoles   String[] @default([])
  
  // Metadata
  generatedBy    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([reportType])
  @@index([status])
  @@index([isScheduled])
  @@index([lastGenerated])
  @@map("audit_reports")
}

// Sync Status Tracking
model SyncStatus {
  id             String   @id @default(cuid())
  userId         String
  deviceId       String
  lastSyncAt     DateTime @default(now())
  syncVersion    Int      @default(1)
  pendingChanges Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceId])
  @@map("sync_status")
}

// Cross-Device Sync Models
model SyncDevice {
  id         String   @id @default(cuid())
  userId     String
  deviceId   String   @unique
  name       String
  type       String   // 'desktop', 'mobile', 'tablet'
  platform   String
  browser    String
  lastActive DateTime @default(now())
  isOnline   Boolean  @default(true)
  location   String?
  ipAddress  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user     User       @relation("UserSyncDevices", fields: [userId], references: [id], onDelete: Cascade)
  syncData SyncData[]

  @@unique([userId, deviceId])
  @@index([userId])
  @@map("sync_devices")
}

model SyncData {
  id        String   @id @default(cuid())
  userId    String
  deviceId  String
  type      String   // 'preferences', 'session', 'cache', 'state'
  dataId    String   // Identifier for the specific data item
  data      Json
  version   BigInt
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User       @relation("UserSyncData", fields: [userId], references: [id], onDelete: Cascade)
  device SyncDevice @relation(fields: [deviceId], references: [deviceId], onDelete: Cascade)

  @@unique([userId, type, dataId])
  @@index([userId, timestamp])
  @@index([deviceId])
  @@map("sync_data")
}

model SyncConflict {
  id              String   @id @default(cuid())
  userId          String
  type            String
  dataId          String
  localData       Json
  remoteData      Json
  localTimestamp  DateTime
  remoteTimestamp DateTime
  localDeviceId   String
  remoteDeviceId  String
  resolved        Boolean  @default(false)
  resolution      String?  // 'local', 'remote', 'merge'
  resolvedData    Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user User @relation("UserSyncConflicts", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, resolved])
  @@map("sync_conflicts")
}

// Document Management System
enum DocumentType {
  PDF
  WORD
  EXCEL
  IMAGE
  OTHER
}

enum DocumentStatus {
  DRAFT
  ACTIVE
  ARCHIVED
  DELETED
}


model DocumentFolder {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  parentId       String?
  path           String   // Full folder path for easy queries
  createdBy      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator        User             @relation("FolderCreator", fields: [createdBy], references: [id])
  parent         DocumentFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id])
  children       DocumentFolder[] @relation("FolderHierarchy")
  documents      Document[]
  permissions    FolderPermission[]
  // Note: Taggings are handled via polymorphic relations in application code

  @@index([organizationId])
  @@index([createdBy])
  @@index([parentId])
  @@index([path])
  @@map("document_folders")
}

model DocumentAnnotation {
  id         String   @id @default(cuid())
  documentId String
  userId     String
  type       String   // 'highlight', 'comment', 'drawing', etc.
  content    String?  // Annotation text/content
  position   Json     // Page/position data
  style      Json?    // Color, size, etc.
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user       User     @relation("DocumentAnnotator", fields: [userId], references: [id])

  @@index([documentId])
  @@index([userId])
  @@map("document_annotations")
}

model DocumentShare {
  id           String    @id @default(cuid())
  documentId   String
  sharedBy     String
  sharedWith   String?   // User ID, null for public/link shares
  shareType    String    // 'user', 'link', 'public'
  permissions  String[]  // 'view', 'comment', 'edit', 'download'
  expiresAt    DateTime?
  accessCount  Int       @default(0)
  lastAccessed DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  document     Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  sharer       User      @relation("DocumentSharer", fields: [sharedBy], references: [id])
  recipient    User?     @relation("DocumentRecipient", fields: [sharedWith], references: [id])

  @@index([documentId])
  @@index([sharedBy])
  @@index([sharedWith])
  @@index([shareType])
  @@map("document_shares")
}

model DocumentComment {
  id         String   @id @default(cuid())
  documentId String
  userId     String
  content    String
  parentId   String?  // For threaded comments
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  document   Document          @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user       User              @relation("DocumentCommenter", fields: [userId], references: [id])
  parent     DocumentComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies    DocumentComment[] @relation("CommentReplies")

  @@index([documentId])
  @@index([userId])
  @@index([parentId])
  @@map("document_comments")
}

model FolderPermission {
  id         String   @id @default(cuid())
  folderId   String
  userId     String?
  role       UserRole?
  permissions String[] // 'view', 'upload', 'edit', 'delete', 'share'
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  folder     DocumentFolder @relation(fields: [folderId], references: [id], onDelete: Cascade)
  user       User?          @relation("FolderPermissionUser", fields: [userId], references: [id])

  @@unique([folderId, userId])
  @@unique([folderId, role])
  @@index([folderId])
  @@index([userId])
  @@index([role])
  @@map("folder_permissions")
}

// Approval Workflow System
model ApprovalWorkflow {
  id             String   @id @default(cuid())
  organizationId String
  taskId         String   @unique
  name           String
  description    String?
  steps          Json     // Array of approval steps with conditions
  isActive       Boolean  @default(true)
  createdBy      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  task           Task         @relation(fields: [taskId], references: [id], onDelete: Cascade)
  creator        User         @relation("WorkflowCreator", fields: [createdBy], references: [id])
  approvalRequests ApprovalRequest[]

  @@index([organizationId])
  @@index([taskId])
  @@index([createdBy])
  @@map("approval_workflows")
}

model ApprovalRequest {
  id             String          @id @default(cuid())
  organizationId String
  workflowId     String
  taskId         String
  stepNumber     Int
  approverId     String
  delegatedFrom  String?         // If this approval was delegated
  status         ApprovalStatus  @default(PENDING)
  decision       ApprovalDecision?
  comments       String?
  decidedAt      DateTime?
  expiresAt      DateTime?
  reminderSentAt DateTime?
  metadata       Json            @default("{}")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  // Relations
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  workflow       ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  task           Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)
  approver       User             @relation("ApprovalRequests", fields: [approverId], references: [id])
  delegatedFromUser User?         @relation("DelegatedApprovals", fields: [delegatedFrom], references: [id])
  
  @@index([organizationId])
  @@index([workflowId])
  @@index([taskId])
  @@index([approverId])
  @@index([status])
  @@index([stepNumber])
  @@map("approval_requests")
}

model ApprovalTemplate {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  category       String?  // e.g., 'audit', 'tax', 'compliance'
  conditions     Json     // Conditions for when this template applies
  steps          Json     // Template approval steps
  isDefault      Boolean  @default(false)
  isActive       Boolean  @default(true)
  createdBy      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator        User         @relation("TemplateCreator", fields: [createdBy], references: [id])

  @@index([organizationId])
  @@index([category])
  @@index([isDefault])
  @@index([isActive])
  @@map("approval_templates")
}

model ApprovalDelegate {
  id             String    @id @default(cuid())
  organizationId String
  delegatorId    String
  delegateId     String
  startDate      DateTime  @default(now())
  endDate        DateTime?
  conditions     Json?     // Optional conditions for delegation
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  delegator      User         @relation("ApprovalDelegator", fields: [delegatorId], references: [id])
  delegate       User         @relation("ApprovalDelegate", fields: [delegateId], references: [id])

  @@unique([delegatorId, delegateId, startDate])
  @@index([organizationId])
  @@index([delegatorId])
  @@index([delegateId])
  @@index([isActive])
  @@map("approval_delegates")
}

// Time Tracking System
model TimeEntry {
  id             String          @id @default(cuid())
  organizationId String
  userId         String
  taskId         String?
  projectId      String?
  clientId       String?
  description    String?
  startTime      DateTime
  endTime        DateTime?
  duration       Int?            // Duration in minutes
  status         TimeEntryStatus @default(RUNNING)
  type           TimeEntryType   @default(WORK)
  isBillable     Boolean         @default(true)
  hourlyRate     Decimal?        @db.Decimal(10, 2)
  totalAmount    Decimal?        @db.Decimal(10, 2)
  tags           String[]
  metadata       Json            @default("{}")
  submittedAt    DateTime?
  approvedAt     DateTime?
  approvedBy     String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation("TimeEntryUser", fields: [userId], references: [id])
  task           Task?        @relation(fields: [taskId], references: [id])
  approver       User?        @relation("TimeEntryApprover", fields: [approvedBy], references: [id])

  @@index([organizationId])
  @@index([userId])
  @@index([taskId])
  @@index([startTime])
  @@index([status])
  @@index([isBillable])
  @@map("time_entries")
}

model TimeBudget {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  taskId         String?
  projectId      String?
  clientId       String?
  userId         String?  // If budget is for specific user
  budgetHours    Decimal  @db.Decimal(8, 2)
  usedHours      Decimal  @default(0) @db.Decimal(8, 2)
  startDate      DateTime
  endDate        DateTime
  alertThreshold Decimal? @db.Decimal(3, 2) // Percentage (0.8 = 80%)
  isActive       Boolean  @default(true)
  createdBy      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  task           Task?        @relation(fields: [taskId], references: [id])
  user           User?        @relation("TimeBudgetUser", fields: [userId], references: [id])
  creator        User         @relation("TimeBudgetCreator", fields: [createdBy], references: [id])

  @@index([organizationId])
  @@index([taskId])
  @@index([userId])
  @@index([startDate, endDate])
  @@index([isActive])
  @@map("time_budgets")
}

model TimeReport {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  reportType     String   // 'timesheet', 'productivity', 'billing', 'project'
  filters        Json     // Report filters and parameters
  generatedBy    String
  generatedAt    DateTime @default(now())
  startDate      DateTime
  endDate        DateTime
  data           Json     // Report data and results
  isScheduled    Boolean  @default(false)
  scheduleConfig Json?    // Cron expression and settings
  lastRunAt      DateTime?
  nextRunAt      DateTime?

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  generator      User         @relation("TimeReportGenerator", fields: [generatedBy], references: [id])

  @@index([organizationId])
  @@index([generatedBy])
  @@index([reportType])
  @@index([generatedAt])
  @@map("time_reports")
}

model ProductivityMetric {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  date           DateTime @db.Date
  totalHours     Decimal  @db.Decimal(8, 2)
  billableHours  Decimal  @db.Decimal(8, 2)
  tasksCompleted Int      @default(0)
  focusScore     Decimal? @db.Decimal(3, 2) // 0-1 scale
  efficiencyScore Decimal? @db.Decimal(3, 2) // 0-1 scale
  utilizationRate Decimal? @db.Decimal(3, 2) // 0-1 scale
  metadata       Json     @default("{}")
  calculatedAt   DateTime @default(now())

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation("ProductivityMetrics", fields: [userId], references: [id])

  @@unique([organizationId, userId, date])
  @@index([organizationId])
  @@index([userId])
  @@index([date])
  @@map("productivity_metrics")
}

// Recurring Task System
enum RecurrencePattern {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

enum RecurrenceEndType {
  NEVER
  AFTER_OCCURRENCES
  ON_DATE
}

model RecurringTask {
  id             String            @id @default(cuid())
  organizationId String
  title          String
  description    String?
  priority       TaskPriority      @default(MEDIUM)
  assignedTo     String?
  createdBy      String
  
  // Recurrence configuration
  pattern        RecurrencePattern
  interval       Int               @default(1) // Every N days/weeks/months
  daysOfWeek     Int[]             // For weekly: [1,2,3,4,5] = Mon-Fri
  dayOfMonth     Int?              // For monthly: 15 = 15th of month
  monthsOfYear   Int[]             // For yearly: [3,6,9,12] = quarterly
  customCron     String?           // For custom patterns
  
  // Recurrence timing
  startDate      DateTime
  endType        RecurrenceEndType @default(NEVER)
  endDate        DateTime?
  maxOccurrences Int?
  
  // Task template
  estimatedHours Int?
  requiresApproval Boolean         @default(false)
  templateData   Json              @default("{}")
  
  // Status
  isActive       Boolean           @default(true)
  isPaused       Boolean           @default(false)
  lastGenerated  DateTime?
  nextDue        DateTime?
  totalGenerated Int               @default(0)
  
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedUser   User?        @relation("RecurringTaskAssignee", fields: [assignedTo], references: [id])
  createdByUser  User         @relation("RecurringTaskCreator", fields: [createdBy], references: [id])
  generatedTasks Task[]

  @@index([organizationId])
  @@index([assignedTo])
  @@index([isActive])
  @@index([nextDue])
  @@index([pattern])
  @@map("recurring_tasks")
}

// Task Automation System
enum TriggerType {
  DEADLINE_APPROACHING
  TASK_OVERDUE
  TASK_COMPLETED
  TASK_CREATED
  WORKLOAD_THRESHOLD
  TIME_BASED
  STATUS_CHANGE
}

enum ActionType {
  ASSIGN_TASK
  ESCALATE_TASK
  CREATE_TASK
  SEND_NOTIFICATION
  UPDATE_PRIORITY
  ADD_COMMENT
  DELEGATE_APPROVAL
}

model AutomationRule {
  id             String      @id @default(cuid())
  organizationId String
  name           String
  description    String?
  
  // Trigger configuration
  triggerType    TriggerType
  triggerConfig  Json        // Specific trigger parameters
  
  // Conditions
  conditions     Json        // Array of conditions to match
  
  // Actions
  actions        Json        // Array of actions to execute
  
  // Settings
  isActive       Boolean     @default(true)
  priority       Int         @default(0) // Higher priority rules execute first
  cooldownMinutes Int?       // Minimum time between executions
  maxExecutions  Int?        // Maximum executions per day
  
  // Statistics
  executionCount Int         @default(0)
  lastExecuted   DateTime?
  successCount   Int         @default(0)
  errorCount     Int         @default(0)
  
  createdBy      String
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator        User         @relation("AutomationRuleCreator", fields: [createdBy], references: [id])
  triggers       AutomationTrigger[]
  executions     AutomationExecution[]

  @@index([organizationId])
  @@index([triggerType])
  @@index([isActive])
  @@index([priority])
  @@map("automation_rules")
}

model AutomationTrigger {
  id             String         @id @default(cuid())
  ruleId         String
  taskId         String?        // Optional task reference
  triggerData    Json           // Data that triggered the rule
  scheduledFor   DateTime?      // For time-based triggers
  isProcessed    Boolean        @default(false)
  processedAt    DateTime?
  createdAt      DateTime       @default(now())

  // Relations
  rule           AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  task           Task?          @relation(fields: [taskId], references: [id])

  @@index([ruleId])
  @@index([taskId])
  @@index([isProcessed])
  @@index([scheduledFor])
  @@map("automation_triggers")
}

model AutomationExecution {
  id             String         @id @default(cuid())
  ruleId         String
  triggerId      String?
  taskId         String?
  
  // Execution details
  status         String         // 'success', 'error', 'partial'
  actionsExecuted Json          // Array of executed actions
  results        Json           // Results of each action
  errorMessage   String?
  executionTime  Int?           // Execution time in milliseconds
  
  executedAt     DateTime       @default(now())

  // Relations
  rule           AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId])
  @@index([taskId])
  @@index([status])
  @@index([executedAt])
  @@map("automation_executions")
}

// Task Assignment Intelligence
model WorkloadMetric {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  date           DateTime @db.Date
  
  // Workload metrics
  activeTasks    Int      @default(0)
  overdueTasks   Int      @default(0)
  completedTasks Int      @default(0)
  totalHours     Decimal  @db.Decimal(8, 2)
  availableHours Decimal  @db.Decimal(8, 2)
  utilizationRate Decimal @db.Decimal(3, 2) // 0-1 scale
  
  // Skill and performance metrics
  avgCompletionTime Decimal? @db.Decimal(8, 2) // Hours
  qualityScore   Decimal?     @db.Decimal(3, 2) // 0-1 scale
  specializations String[]    // Areas of expertise
  
  calculatedAt   DateTime @default(now())

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation("WorkloadMetrics", fields: [userId], references: [id])

  @@unique([organizationId, userId, date])
  @@index([organizationId])
  @@index([userId])
  @@index([date])
  @@index([utilizationRate])
  @@map("workload_metrics")
}

// Task Escalation System
model EscalationRule {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  
  // Trigger conditions
  conditions     Json     // When to escalate (overdue hours, priority, etc.)
  
  // Escalation levels
  levels         Json     // Array of escalation levels with actions
  
  // Settings
  isActive       Boolean  @default(true)
  priority       Int      @default(0)
  
  createdBy      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator        User         @relation("EscalationRuleCreator", fields: [createdBy], references: [id])
  logs           EscalationLog[]

  @@index([organizationId])
  @@index([isActive])
  @@index([priority])
  @@map("escalation_rules")
}

model EscalationLog {
  id             String         @id @default(cuid())
  taskId         String
  ruleId         String
  level          Int
  action         String         // Action taken (notify, reassign, etc.)
  actionData     Json           // Details of the action
  executedBy     String?        // User who triggered (null for system)
  executedAt     DateTime       @default(now())

  // Relations
  task           Task           @relation(fields: [taskId], references: [id], onDelete: Cascade)
  rule           EscalationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([ruleId])
  @@index([level])
  @@index([executedAt])
  @@map("escalation_logs")
}

// Task Suggestions System
model TaskSuggestion {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  
  // Suggestion details
  type           String   // 'recurring', 'similar', 'workload', 'deadline'
  title          String
  description    String?
  confidence     Decimal  @db.Decimal(3, 2) // 0-1 confidence score
  
  // Suggested task data
  suggestedData  Json     // Task creation data
  reasoning      Json     // Why this was suggested
  
  // Status
  status         String   @default("pending") // 'pending', 'accepted', 'rejected', 'expired'
  respondedAt    DateTime?
  expiresAt      DateTime?
  
  createdAt      DateTime @default(now())

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation("TaskSuggestions", fields: [userId], references: [id])

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([confidence])
  @@index([expiresAt])
  @@map("task_suggestions")
}

// Client Portal System

// Client Status Enum
enum ClientStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

// Client Engagement Status Enum
enum EngagementStatus {
  PLANNING
  IN_PROGRESS
  REVIEW
  COMPLETED
  ON_HOLD
  CANCELLED
}

// Document Request Status Enum
enum DocumentRequestStatus {
  PENDING
  UPLOADED
  REVIEWED
  APPROVED
  REJECTED
  EXPIRED
}

// Client Model
model Client {
  id             String       @id @default(cuid())
  organizationId String
  
  // Basic Information
  name           String
  email          String
  phone          String?
  companyName    String?
  gstin          String?      // GST Identification Number
  pan            String?      // PAN Number
  
  // Address
  address        Json?        // Structured address data
  
  // Portal Access
  passwordHash   String?      // For client portal login
  isPortalEnabled Boolean     @default(true)
  lastLoginAt    DateTime?
  
  // Status and Settings
  status         ClientStatus @default(ACTIVE)
  preferences    Json         @default("{}")
  
  // Branding
  brandingConfig Json?        // Custom branding for this client
  
  // Metadata
  metadata       Json         @default("{}")
  createdBy      String       // CA firm user who created this client
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  engagements    ClientEngagement[]
  documentRequests ClientDocumentRequest[]
  uploadedDocuments ClientDocument[]
  messages       ClientMessage[]
  notifications  ClientNotification[]
  feedbacks      ClientFeedback[]
  meetings       ClientMeeting[]
  invoices       ClientInvoice[]
  progressUpdates ClientProgressUpdate[]

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
  @@index([status])
  @@index([createdBy])
  @@map("clients")
}

// Client Engagement Model
model ClientEngagement {
  id             String           @id @default(cuid())
  organizationId String
  clientId       String
  
  // Engagement Details
  name           String
  description    String?
  type           String           // 'audit', 'tax_filing', 'compliance', 'consultation'
  status         EngagementStatus @default(PLANNING)
  priority       TaskPriority     @default(MEDIUM)
  
  // Timeline
  startDate      DateTime?
  expectedEndDate DateTime?
  actualEndDate  DateTime?
  
  // Team Assignment
  leadPartnerId  String?          // Lead partner for this engagement
  teamMembers    String[]         // Array of user IDs
  
  // Financial
  estimatedValue Decimal?         @db.Decimal(12, 2)
  actualValue    Decimal?         @db.Decimal(12, 2)
  currency       String           @default("INR")
  
  // Progress Tracking
  completionPercentage Int        @default(0)
  milestones     Json             @default("[]") // Array of milestone objects
  
  // Client Visibility
  isVisibleToClient Boolean       @default(true)
  clientNotes    String?          // Notes visible to client
  internalNotes  String?          // Internal notes not visible to client
  
  // Metadata
  metadata       Json             @default("{}")
  createdBy      String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tasks          ClientEngagementTask[]
  documentRequests ClientDocumentRequest[]
  progressUpdates ClientProgressUpdate[]
  invoices       ClientInvoice[]
  feedbacks      ClientFeedback[]
  meetings       ClientMeeting[]

  @@index([organizationId])
  @@index([clientId])
  @@index([status])
  @@index([leadPartnerId])
  @@index([startDate])
  @@map("client_engagements")
}

// Client Engagement Task Model (links tasks to engagements)
model ClientEngagementTask {
  id           String           @id @default(cuid())
  engagementId String
  taskId       String
  
  // Client visibility settings
  isVisibleToClient Boolean     @default(false)
  clientDescription String?     // Client-friendly description
  
  createdAt    DateTime         @default(now())

  // Relations
  engagement   ClientEngagement @relation(fields: [engagementId], references: [id], onDelete: Cascade)
  task         Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([engagementId, taskId])
  @@index([engagementId])
  @@index([taskId])
  @@map("client_engagement_tasks")
}

// Client Document Request Model
model ClientDocumentRequest {
  id             String                @id @default(cuid())
  organizationId String
  clientId       String
  engagementId   String?
  
  // Request Details
  title          String
  description    String
  category       String?               // 'financial', 'legal', 'compliance', etc.
  priority       TaskPriority          @default(MEDIUM)
  
  // Requirements
  requiredDocuments Json               @default("[]") // Array of required document types
  optionalDocuments Json               @default("[]") // Array of optional document types
  instructions   String?               // Special instructions for client
  
  // Status and Timeline
  status         DocumentRequestStatus @default(PENDING)
  dueDate        DateTime?
  completedAt    DateTime?
  
  // Uploaded Documents
  uploadedCount  Int                   @default(0)
  requiredCount  Int                   @default(0)
  
  // Notifications
  reminderSentAt DateTime?
  lastNotifiedAt DateTime?
  
  // Metadata
  metadata       Json                  @default("{}")
  createdBy      String
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  // Relations
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  engagement     ClientEngagement?     @relation(fields: [engagementId], references: [id])
  documents      ClientDocument[]

  @@index([organizationId])
  @@index([clientId])
  @@index([engagementId])
  @@index([status])
  @@index([dueDate])
  @@map("client_document_requests")
}

// Client Document Model
model ClientDocument {
  id             String                @id @default(cuid())
  organizationId String
  clientId       String
  requestId      String?               // Optional link to document request
  
  // Document Information
  name           String
  originalName   String
  description    String?
  category       String?
  
  // File Information
  filePath       String
  fileSize       Int
  mimeType       String
  checksum       String?
  
  // Status and Review
  status         DocumentRequestStatus @default(UPLOADED)
  reviewNotes    String?               // Notes from CA firm review
  
  // Client Information
  uploadedByClient Boolean             @default(true)
  clientNotes    String?               // Notes from client
  
  // Metadata
  metadata       Json                  @default("{}")
  uploadedAt     DateTime              @default(now())
  reviewedAt     DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  // Relations
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  request        ClientDocumentRequest? @relation(fields: [requestId], references: [id])

  @@index([organizationId])
  @@index([clientId])
  @@index([requestId])
  @@index([status])
  @@index([uploadedAt])
  @@map("client_documents")
}

// Client Communication Model
model ClientMessage {
  id             String   @id @default(cuid())
  organizationId String
  clientId       String
  
  // Message Details
  subject        String?
  content        String
  messageType    String   @default("message") // 'message', 'notification', 'update'
  
  // Sender Information
  fromClient     Boolean  @default(false) // true if from client, false if from CA firm
  fromUserId     String?  // CA firm user who sent (if fromClient = false)
  
  // Status
  isRead         Boolean  @default(false)
  readAt         DateTime?
  
  // Threading
  parentId       String?  // For threaded conversations
  
  // Attachments
  attachments    Json     @default("[]") // Array of attachment references
  
  // Metadata
  metadata       Json     @default("{}")
  sentAt         DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  parent         ClientMessage? @relation("MessageReplies", fields: [parentId], references: [id])
  replies        ClientMessage[] @relation("MessageReplies")

  @@index([organizationId])
  @@index([clientId])
  @@index([fromClient])
  @@index([isRead])
  @@index([sentAt])
  @@map("client_messages")
}

// Client Notification Model
model ClientNotification {
  id             String   @id @default(cuid())
  organizationId String
  clientId       String
  
  // Notification Details
  type           String   // 'document_request', 'status_update', 'meeting_reminder', etc.
  title          String
  message        String
  
  // Delivery Channels
  channels       String[] @default(["portal"]) // 'portal', 'email', 'sms'
  
  // Status
  isRead         Boolean  @default(false)
  readAt         DateTime?
  
  // Delivery Status
  emailSent      Boolean  @default(false)
  emailSentAt    DateTime?
  smsSent        Boolean  @default(false)
  smsSentAt      DateTime?
  
  // Action
  actionUrl      String?  // URL for client to take action
  actionLabel    String?  // Label for action button
  
  // Metadata
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([clientId])
  @@index([type])
  @@index([isRead])
  @@index([createdAt])
  @@map("client_notifications")
}

// Client Feedback Model
model ClientFeedback {
  id             String   @id @default(cuid())
  organizationId String
  clientId       String
  engagementId   String?
  
  // Feedback Details
  type           String   // 'satisfaction', 'service_quality', 'suggestion', 'complaint'
  rating         Int?     // 1-5 rating scale
  title          String?
  feedback       String
  
  // Categories
  categories     String[] @default([]) // Areas of feedback
  
  // Status
  status         String   @default("new") // 'new', 'reviewed', 'responded', 'resolved'
  response       String?  // Response from CA firm
  respondedBy    String?  // User who responded
  respondedAt    DateTime?
  
  // Metadata
  metadata       Json     @default("{}")
  submittedAt    DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  engagement     ClientEngagement? @relation(fields: [engagementId], references: [id])

  @@index([organizationId])
  @@index([clientId])
  @@index([engagementId])
  @@index([type])
  @@index([status])
  @@index([rating])
  @@map("client_feedbacks")
}

// Client Meeting Model
model ClientMeeting {
  id             String   @id @default(cuid())
  organizationId String
  clientId       String
  engagementId   String?
  
  // Meeting Details
  title          String
  description    String?
  type           String   @default("consultation") // 'consultation', 'review', 'planning'
  
  // Scheduling
  scheduledAt    DateTime
  duration       Int      @default(60) // Duration in minutes
  timezone       String   @default("Asia/Kolkata")
  
  // Meeting Information
  location       String?  // Physical location or meeting link
  meetingLink    String?  // Video conference link
  agenda         Json?    // Meeting agenda items
  
  // Participants
  attendees      String[] @default([]) // Array of user IDs from CA firm
  
  // Status
  status         String   @default("scheduled") // 'scheduled', 'completed', 'cancelled', 'rescheduled'
  
  // Follow-up
  notes          String?  // Meeting notes
  actionItems    Json?    // Action items from meeting
  followUpDate   DateTime?
  
  // Reminders
  reminderSent   Boolean  @default(false)
  reminderSentAt DateTime?
  
  // Metadata
  metadata       Json     @default("{}")
  createdBy      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  engagement     ClientEngagement? @relation(fields: [engagementId], references: [id])

  @@index([organizationId])
  @@index([clientId])
  @@index([engagementId])
  @@index([scheduledAt])
  @@index([status])
  @@map("client_meetings")
}

// Client Invoice Model
model ClientInvoice {
  id             String           @id @default(cuid())
  organizationId String
  clientId       String
  engagementId   String?
  
  // Invoice Details
  invoiceNumber  String
  title          String
  description    String?
  
  // Financial Information
  subtotal       Decimal          @db.Decimal(12, 2)
  taxAmount      Decimal          @default(0) @db.Decimal(12, 2)
  totalAmount    Decimal          @db.Decimal(12, 2)
  currency       String           @default("INR")
  
  // Line Items
  lineItems      Json             @default("[]") // Array of invoice line items
  
  // Status and Dates
  status         String           @default("draft") // 'draft', 'sent', 'paid', 'overdue', 'cancelled'
  issueDate      DateTime         @default(now())
  dueDate        DateTime?
  paidDate       DateTime?
  
  // Payment Information
  paymentMethod  String?
  paymentReference String?
  
  // File Information
  filePath       String?          // Path to generated invoice PDF
  
  // Metadata
  metadata       Json             @default("{}")
  createdBy      String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  engagement     ClientEngagement? @relation(fields: [engagementId], references: [id])

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId])
  @@index([clientId])
  @@index([engagementId])
  @@index([status])
  @@index([dueDate])
  @@map("client_invoices")
}

// Client Progress Update Model
model ClientProgressUpdate {
  id             String           @id @default(cuid())
  organizationId String
  clientId       String
  engagementId   String
  
  // Update Details
  title          String
  description    String
  updateType     String           @default("progress") // 'progress', 'milestone', 'status_change'
  
  // Progress Information
  previousStatus String?
  currentStatus  String?
  completionPercentage Int?
  
  // Milestone Information
  milestoneId    String?          // Reference to milestone in engagement
  milestoneName  String?
  
  // Visibility
  isVisibleToClient Boolean       @default(true)
  
  // Metadata
  metadata       Json             @default("{}")
  createdBy      String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  engagement     ClientEngagement @relation(fields: [engagementId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([clientId])
  @@index([engagementId])
  @@index([updateType])
  @@index([createdAt])
  @@map("client_progress_updates")
}
// Dashboard and Analytics Models
enum DashboardWidgetType {
  TASK_OVERVIEW
  TASK_BOARD
  COMPLIANCE_STATUS
  TEAM_PERFORMANCE
  WORKLOAD_ANALYTICS
  TIME_TRACKING
  DOCUMENT_STATS
  EMAIL_STATS
  PRODUCTIVITY_METRICS
  CLIENT_ENGAGEMENT
  LEARNING_PROGRESS
  DEADLINES
  NOTIFICATIONS
  QUICK_ACTIONS
  ANALYTICS_CHART
  KPI_CARD
  ACTIVITY_FEED
}

model DashboardLayout {
  id          String    @id @default(cuid())
  name        String
  description String?
  role        UserRole?
  isDefault   Boolean   @default(false)
  widgets     DashboardWidget[]
  createdBy   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([role])
  @@index([isDefault])
  @@index([createdBy])
  @@map("dashboard_layouts")
}

model DashboardWidget {
  id              String              @id @default(cuid())
  dashboardId     String
  type            DashboardWidgetType
  title           String
  position        Json                // { x, y, w, h }
  config          Json?               // Widget-specific configuration
  refreshInterval Int?                // Refresh interval in seconds
  isVisible       Boolean             @default(true)
  minSize         Json?               // { w, h }
  maxSize         Json?               // { w, h }
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  dashboard       DashboardLayout     @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  @@index([dashboardId])
  @@index([type])
  @@map("dashboard_widgets")
}